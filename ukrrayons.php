<?php

/**
 * Return a list of all the counties
 */

function uscounties_listcounties() {
  $counties = array(
    1000 => array( // Вінницька область
      'Барський район',
      'Бершадський район',
      'Вінницький район',
      'Гайсинський район',
      'Жмеринський район',
      'Іллінецький район',
      'Калинівський район',
      'Козятинський район',
      'Крижопільський район',
      'Липовецький район',
      'Літинський район',
      'Могилів-Подільський район',
      'Мурованокуриловецький район',
      'Немирівський район',
      'Оратівський район',
      'Піщанський район',
      'Погребищенський район',
      'Теплицький район',
      'Тиврівський район',
      'Томашпільський район',
      'Тростянецький район',
      'Тульчинський район',
      'Хмільницький район',
      'Чернівецький район',
      'Чечельницький район',
      'Шаргородський район',
      'Ямпільський район',
    ),
    1001 => array( // Волинська область
      'Володимир-Волинський район',
      'Горохівський район',
      'Іваничівський район',
      'Камінь-Каширський район',
      'Ківерцівський район',
      'Ковельський район',
      'Локачинський район',
      'Луцький район',
      'Любешівський район',
      'Любомлський район',
      'Маневицький район',
      'Ратнівський район',
      'Рожищенський район',
      'Старовижівський район',
      'Турійський район',
      'Шацький район',
    ),
    1002 => array( // Дніпропетровська область
      'Апостолівський район',
      'Васильківський район',
      'Верхньодніпровський район',
      'Дніпропетровський район',
      'Криворізький район',
      'Криничанський район',
      'Магдалинівський район',
      'Межівський район',
      'Нікопольський район',
      'Новомосковський район',
      'Павлоградський район',
      'Петриківський район',
      'Петропавлівський район',
      'Покровський район',
      'Пятихатський район',
      'Синельниківський район'
      'Солонянський район'
      'Софіївський район'
      'Томаківський район'
      'Царичанський район'
      'Широківський район'
      'Юрївський район'
    ),
    1003 => array( // Донецька область
      'Амвросіївський район',
      'Артмемівський район',
      'Великоновосілківський район',
      'Волноваський район',
      'Володарський район',
      'Добропільський район',
      'Констянтинівський район',
      'Красноармійський район',
      'Краснолиманський район',
      'Марїнський район',
      'Новоазовський район',
      'Олександрівський район',
      'Першотравнений район',
      'Словянський район',
      'Старобешівський район',
      'Тельманівський район',
      'Шахтарський район',
      'Ясинуватський район',
    ),
    1004 => array( // Житомирська область
      'Андрушівський район',
      'Баранівський район',
      'Бердичівський район',
      'Брусилівський район',
      'Володарсько-Волинський район',
      'Ємільчинський район',
      'Житомирський район',
      'Коростенський район',
      'Коростишівський район',
      'Лугинський район',
      'Любарський район',
      'Малинський район',
      'Народицький район',
      'Новоград-Волинський район',
      'Овруцький район',
      'Олевський район',
      'Попільнянський район',
      'Радомишльський район',
      'Романівський район',
      'Ружинський район',
      'Червоноармійський район',
      'Черняхівський район',
      'Чуднівський район',
    ),
    1005 => array( // Закарпатська область
      'Берегівський район',
      'Великоберезнянський район',
      'Виноградівський район',
      'Воловецький район',
      'Іршавський район',
      'Міжгірський район',
      'Мукачівський район',
      'Перечинський район',
      'Рахівський район',
      'Свалявський район',
      'Тячівський район',
      'Ужгородський район',
      'Хустський район', 
    ),
    1006 => array( // Запорізька область
      'Бердянський район',
      'Василівський район',
      'Великобілозерський район',
      'Веселівський район',
      'Вільнянський район',
      'Гуляйпільський район',
      'Запорізький район',
      'Камянсько-Дніпровський район',
      'Куйбишевський район',
      'Мелітопольський район',
      'Михайлівський район',
      'Новомиколаївський район',
      'Оріхівський район',
      'Пологівський район',
      'Приазовський район',
      'Приморський район',
      'Розівський район',
      'Токмацький район',
      'Чернігівський район',
      'Якимівський район',
    ),
    1007 => array( // Івано-Франківська область
      'Богородчанський район',
      'Верховинський район',
      'Галицький район',
      'Городенківський район',
      'Долинський район',
      'Калуський район',
      'Коломийський район',
      'Косівський район',
      'Надвірнянський район',
      'Рогатинський район',
      'Рожнятівський район',
      'Снятинський район',
      'Тисменицький район',
      'Тлумацький район',
    ),
    1008 => array( // Київська область
      'Баришівський район',
      'Білоцерківський район',
      'Богуславський район',
      'Бориспільський район',
      'Бородянський район',
      'Броварський район',
      'Васильківський район',
      'Вишгородський район',
      'Володарський район',
      'Згурівський район',
      'Іванківський район',
      'Кагарлицький район',
      'Києво-Святошинський район',
      'Макарівський район',
      'Миронівський район',
      'Обухівський район',
      'Переяслав-Хмельницький район',
      'Поліський район',
      'Рокитнянський район',
      'Сквирський район',
      'Ставищенський район',
      'Теращанський район',
      'Тетіївський район',
      'Фастівський район',
      'Яготинський район',
   ),
    1009 => array( // Кіровоградська область
      'Бобринецький район',
      'Вільшанський район',
      'Гайворонський район',
      'Голованівський район',
      'Добровеличківський район',
      'Долинський район',
      'Знамянський район',
      'Кіровоградський район',
      'Компаніївський район',
      'Маловисківський район',
      'Новгородківський район',
      'Новоархангельський район',
      'Новомиргородський район',
      'Новоукраїнський район',
      'Олександрівський район',
      'Олександрійський район',
      'Онуфріївський район',
      'Петрівський район',
      'Світловодський район',
      'Ульяновський район',
      'Устинівський район'
    ),
    1010 => array( // Луганська область
      'Антрацитівський район',
      'Біловодський район',
      'Білокуракинський район',
      'Краснодонський район',
      'Кремінський район',
      'Лутугинський район',
      'Марківський район',
      'Міловський район',
      'Новоайдарський район',
      'Новопсковський район',
      'Перевальський район',
      'Попаснянський район',
      'Сватівський район',
      'Свердловський район',
      'Словяносербський район',
      'Станично-луганський район',
      'Старобільський район',
      'Троїцький район',
    ),
    1011 => array( // Львівська область
      'Бродівський район',
      'Буський район',
      'Городоцький район',
      'Дрогобицький район',
      'Жидачівський район',
      'Жовківський район',
      'Золочівський район',
      'Камянка-Бузький район',
      'Миколаївський район',
      'Мостиський район',
      'Перемишлянський район',
      'Пустомитівський район',
      'Радехівський район',
      'Самбірський район',
      'Сколівський район',
      'Сокальський район',
      'Старосамбірський район',
      'Стрийський район',
      'Турківський район',
      'Яворівський район',
    ),
    1012 => array( // Миколаївська область
      'Арбузинський район',
      'Баштанський район',
      'Березанський район',
      'Березнегуватський район',
      'Братський район',
      'Веселинівський район',
      'Вознесенський район',
      'Врадіївський район',
      'Доманівський район',
      'Єланецький район',
      'Жовтневий район',
      'Казанівський район',
      'Кривоозерський район',
      'Миколаївський район',
      'Новобузький район',
      'Новоодеський район',
      'Очаківський район',
      'Первомайський район',
      'Снігурівський район',
    ),
    1013 => array( // Одеська область
      'Ананьївський район',
      'Арцизький район',
      'Балтський район',
      'Березівський район',
      'Білгород-Дністровський район',
      'Біляївський район',
      'Болградський район',
      'Великомихайлівський район',
      'Іванівський район',
      'Ізмаїльський район',
      'Кілійський район',
      'Кодимський район',
      'Комінтернівський район',
      'Котовський район',
      'Красноокнянський район',
      'Любашівський район',
      'Миколаївський район',
      'Овідопольський район',
      'Ренійський район',
      'Роздільнянський район',
      'Савранський район',
      'Саратський район',
      'Тарутинський район',
      'Татарбунарський район',
      'Фрунзівський район',
      'Ширяївський район',
    ),
    1014 => array( // Полтавська область
      'Великобагачанський район',
      'Гадяцький район',
      'Глобинський район',
      'Гребінківський район',
      'Диканський район',
      'Зіньківський район',
      'Карлівський район',
      'Кобеляцький район',
      'Козельщинський район',
      'Котелевський район',
      'Кременчуцький район',
      'Лохвицький район',
      'Лубенський район',
      'Машівський район',
      'Миргородський район',
      'Новосанжарський район',
      'Оржицький район',
      'Пирятинський район',
      'Полтавський район',
      'Решетилівський район',
      'Семенівський район',
      'Хорольський район',
      'Чорнухинський район',
      'Чутівський район',
      'Шишацький район',
    ),
    1015 => array( // Рівненська область
      'Березнівський район',
      'Володимирський район',
      'Гощанський район',
      'Демидівський район',
      'Дубенський район',
      'Дубровицький район',
      'Зарічневський район',
      'Здолбунівський район',
      'Корецький район',
      'Костопільський район',
      'Млинівський район',
      'Острозький район',
      'Радивилівський район',
      'Рівненський район',
      'Рокитнівський район',
      'Сарненський район',
    ),
    1016 => array( // Сумська область
      'Білопільський район',
      'Буринський район',
      'Великописарівський район',
      'Глухівський район',
      'Конотопський район',
      'Краснопільський район',
      'Кролевецький район',
      'Лебединський район',
      'Липоводолинський район',
      'Недригайлівський район',
      'Охтирський район',
      'Путивлський район',
      'Роменський район',
      'Середино-Будський район',
      'Сумський район',
      'Тростянецький район',
      'Шостинський район',
      'Ямпільський район',
    ),
    1017 => array( // Тернопільська область
      'Бережанський район',
      'Борщівський район',
      'Бучацький район',
      'Гусятинський район',
      'Заліщицький район',
      'Збаразький район',
      'Зборівський район',
      'Козівський район',
      'Кременецький район',
      'Лановецький район',
      'Монастирський район',
      'Підволочиський район',
      'Підгаєцький район',
      'Теребовлянський район',
      'Тернопільський район',
      'Чотрківський район',
      'Шумський район',
    ),
    1018 => array( // Харківська область
      'Балаклійський район',
      'Барвінківський район',
      'Близнюківський район',
      'Богодухівський район',
      'Борівський район',
      'Валківський район',
      'Великобурлуцький район',
      'Вовчанський район',
      'Дворічанський район',
      'Дергачівський район',
      'Зачепилівський район',
      'Зміївський район',
      'Золочівський район',
      'Ізюмський район',
      'Кегичівський район',
      'Коломацький район',
      'Красноградський район',
      'Краснокудський район',
      'Купянський район',
      'Лозівський район',
      'Нововодолазький район',
      'Первомайський район',
      'Печенізький район',
      'Сахновщинський район',
      'Харківський район',
      'Чугуївський район',
      'Шевченківський район',
    ),
    1019 => array( // Херсонська область
      'Бериславський район',
      'Білозерський район',
      'Великолепетиський район',
      'Верхньорогачицький район',
      'Високопільський район',
      'Генічеський район',
      'Голопристанський район',
      'Горностаївський район',
      'Іванівський район',
      'Каланчацький район',
      'Каховський район',
      'Нижньосірогозький район',
      'Нововоронцовський район',
      'Новотроїцький район',
      'Скадовський район',
      'Цюрупинський район',
      'Чаплинський район', 
    ),
    1020 => array( // Хмельницька область
      'Білогірський район',
      'Віньковецький район',
      'Волочиський район',
      'Городоцький район',
      'Деражнянський район',
      'Дунаєвецький район',
      'Ізяславський район',
      'Камянець-Подільський район',
      'Красилівський район',
      'Летичівський район',
      'Новоушицький район',
      'Полонський район',
      'Славутський район',
      'Староконстянтинівський район',
      'Старосинявський район',
      'Теофіпольський район',
      'Хмельницький район',
      'Чемеровецький район',
      'Шепетівський район',
      'Ярмолинецький район',
    ),
    1021 => array( // Черкаська область
      'Городищенський район',
      'Драбівський район',
      'Жашківський район',
      'Звенигородський район',
      'Золотоніський район',
      'Камянський район',
      'Канівський район',
      'Катеринопільський район',
      'Корсунь-Шевченківський район',
      'Лисянський район',
      'Маньківський район',
      'Монастирищенський район',
      'Смілянський район',
      'Тальнівський район',
      'Уманський район',
      'Христинівський район',
      'Черкаський район',
      'Чигиринський район',
      'Чорнобаївський район',
      'Шполянський район',
    ),
    1022 => array( // Чернівецька область
      'Вижницький район',
      'Герцаївський район',
      'Глибоцький район',
      'Заставнівський район',
      'Кельменецький район',
      'Кіцманський район',
      'Новоселецький район',
      'Путильський район',
      'Сокирянський район',
      'Сторожинецький район',
      'Хотинський район',
    ),
    1023 => array( // Чернігівська область
      'Бахмацький район',
      'Бобровицький район',
      'Борзнянський район',
      'Варвинський район',
      'Городнянський район',
      'Ічнянський район',
      'Козелецький район',
      'Коропський район',
      'Корюківський район',
      'Куликівський район',
      'Менський район',
      'Ніжинський район',
      'Новгород-Сіверський район',
      'Носівський район',
      'Прилуцький район',
      'Ріпкинський район',
      'Семенівський район',
      'Сосницький район',
      'Срібнянський район',
      'Талалаївський район',
      'Чернігівський район',
      'Щорський район',
    ),
    1024 => array( // Київ
      'Голосіївський район',
      'Дарницький район',
      'Деснянський район',
      'Дніпровський район',
      'Оболонський район',
      'Печерський район',
      'Подільський район',
      'Святошинський район',
      'Соломянський район',
      'Шевченківський',
    ),
    1025 => array( // Севастополь
      'Балаклавський район',
      'Гагарінський район',
      'Ленінський район',
      'Нахімовський район',
    ),
    1026 => array( // Автономна Республіка Крим
      'Бахчисарайський район',
      'Білогірський район',
      'Джанкойський район',
      'Кіровський район',
      'Красногвардійський район',
      'Красноперекопський район',
      'Ленінський район',
      'Нижньогірський район',
      'Первомайський район',
      'Роздольненський район',
      'Сакський район',
      'Сімферопольський район',
      'Совєтський район',
      'Чорноморський район',
    ),
  );
  
  return $counties;
}

/**
 * Check and load counties
 */

function uscounties_loadcounties() {

  $counties = uscounties_listcounties();

  static $dao = NULL;
  if (!$dao) {
    $dao = new CRM_Core_DAO();
  }

  // go state-by-state to check existing counties

  foreach ($counties as $id => $state) {
    $check = "SELECT name FROM civicrm_county WHERE state_province_id = $id";
    $results = CRM_Core_DAO::executeQuery($check);
    $existing = array();
    while ($results->fetch()) {
      $existing[] = $results->name;
    }

    // identify counties needing to be loaded
    $add = array_diff($state, $existing);
    
    $insert = array();
    foreach ($add as $county) {
      $countye = $dao->escape($county);
      $insert[] = "('$countye', $id)";
    }
    
    // put it into queries of 50 counties each
    for($i = 0; $i < count($insert); $i = $i+50) {
      $inserts = array_slice($insert, $i, 50);
      $query = "INSERT INTO civicrm_county (name, state_province_id) VALUES ";
      $query .= implode(', ', $inserts);
      CRM_Core_DAO::executeQuery($query);
    }
  }
}

/**
 * Implementation of hook_civicrm_install
 *
 * @link http://wiki.civicrm.org/confluence/display/CRMDOC/hook_civicrm_install
 */
function uscounties_civicrm_install() {
  uscounties_loadcounties();
}

/**
 * Implementation of hook_civicrm_enable
 *
 * @link http://wiki.civicrm.org/confluence/display/CRMDOC/hook_civicrm_enable
 */
function uscounties_civicrm_enable() {
  uscounties_loadcounties();
}

/**
 * Implementation of hook_civicrm_upgrade
 *
 * @param $op string, the type of operation being performed; 'check' or 'enqueue'
 * @param $queue CRM_Queue_Queue, (for 'enqueue') the modifiable list of pending up upgrade tasks
 *
 * @return mixed  based on op. for 'check', returns array(boolean) (TRUE if upgrades are pending)
 *                for 'enqueue', returns void
 *
 * @link http://wiki.civicrm.org/confluence/display/CRMDOC/hook_civicrm_upgrade
 */
function uscounties_civicrm_upgrade($op, CRM_Queue_Queue $queue = NULL) {
  uscounties_loadcounties();
}
